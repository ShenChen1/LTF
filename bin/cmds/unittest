#!/usr/bin/env bash

set -aeu
source _shellflags

check_test_config() {
    case "$TESTCONFIG" in
    /*) true ;;
    *) TESTCONFIG="$(pwd)/$TESTCONFIG" ;;
    esac

    checktestconfig || exit 1
}

process_host_script() {
    bash "$1"
}

process_target_script() {
    putfile "$1" "$1"
    invoke "bash $1"
    invoke "rm $1"
}

process_target_cpp() {
    compile "$1"
    for APP in "__$1"*; do
        [ -f "$APP" ] || continue
        putfile "$APP" "$APP"
        invoke "chmod +x $APP && ./$APP"
        invoke "rm $APP"
    done
}

main() {
    # check config file
    check_test_config

    for ARG in *; do
        [ -f "$ARG" ] || continue
        case "$ARG" in
        host_*.sh)
            process_host_script "$ARG"
            ;;
        *.sh)
            process_target_script "$ARG"
            ;;
        *.c | *.cpp)
            process_target_cpp "$ARG"
            ;;
        esac
    done
}

main "$@"

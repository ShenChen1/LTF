#!/usr/bin/env bash

set -aeu
source _shellflags

check_test_config() {
    case "$TESTCONFIG" in
    /*) true ;;
    *) TESTCONFIG="$(pwd)/$TESTCONFIG" ;;
    esac

    checktestconfig || exit 1
}

process_host_script() {
    bash "$1"
}

process_target_script() {
    putfile "$1" "$1"
    invoke "sh $1"
    invoke "rm $1"
}

process_target_cpp() {
    local APP=__${1%%.*}
    compile "$1"
    putfile "$APP" "$APP"
    invoke "chmod +x $APP && ./$APP"
    invoke "rm $APP"
}

main() {
    __HOST=false

    # check config file
    check_test_config

    for ARG in host_*; do
        [ -f "$ARG" ] || continue
        case "$ARG" in
        host_*.sh)
            process_host_script "$ARG"
            __HOST=true
            ;;
        esac
    done

    $__HOST || { 
        for ARG in *; do
            [ -f "$ARG" ] || continue
            case "$ARG" in
            *.sh)
                process_target_script "$ARG"
                ;;
            *.c | *.cpp)
                process_target_cpp "$ARG"
                ;;
            esac
        done
    }
}

main "$@"

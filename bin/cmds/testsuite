#!/usr/bin/env bash

set -aeu
source _shellflags

do_test() {
    local path="$1"
    makecall -C "$path" test
}

do_result() {

}

do_serial() {
    local -r tests="$1"

    for t in $tests; do
        do_test "$t"
        do_result "$t"
    done
}

killtree() {
    local _pid=$1
    local _sig=${2:-SIGTERM}

    for _child in $(ps -o pid --no-headers --ppid ${_pid}); do
        killtree ${_child} ${_sig}
    done
    kill -s ${_sig} ${_pid} || true
}

do_parallel() {
    local -r tests="$1"
    local _pids=""

    trap_handler() {
        for p in $_pids; do
            chains=$(pstree -p $p)
            [ "$chains" != "" ] && echo $chains; killtree $p
        done
        exit 1
    }

    trap trap_handler 1 2 3 15
    for t in $tests; do
        (do_test "$t") &
        _pids="$_pids $!"
    done
    wait
    _pids=""

    for t in $tests; do
        do_result "$t"
    done
}

main() {
    local -r tests=${TESTSUITE_TESTS-}
    unset TESTSUITE_TESTS

    if ${TESTSUITE_PARALLEL:-false}; then
        do_parallel "$tests"
    else
        do_serial "$tests"
    fi
}

main "$@"